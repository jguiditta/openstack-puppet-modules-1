From c6b7a77538a514e7dd2c0056c72f421a385e268d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Martin=20M=C3=A1gr?= <mmagr@redhat.com>
Date: Fri, 3 Oct 2014 20:18:17 +0200
Subject: [PATCH] [neutron] Fixes plugin.ini error

When executing the cisco.pp manifest it throws an error
if the plugin.ini file is already declared.

I know this plugin will be deprecated in juno but this change
is needed for icehouse.

Change-Id: I9b8efe668911013d4fd801def15d0c4c384e42ca
---
 neutron/manifests/plugins/cisco.pp                 | 14 +++++++++-----
 neutron/spec/classes/neutron_plugins_cisco_spec.rb |  3 +--
 2 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/neutron/manifests/plugins/cisco.pp b/neutron/manifests/plugins/cisco.pp
index 3db672e..92d5c4a 100644
--- a/neutron/manifests/plugins/cisco.pp
+++ b/neutron/manifests/plugins/cisco.pp
@@ -171,9 +171,13 @@ class neutron::plugins::cisco(
 
   # In RH, this link is used to start Neutron process but in Debian, it's used only
   # to manage database synchronization.
-  ensure_resource('file', '/etc/neutron/plugin.ini', {
-    ensure  => link,
-    target  => '/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini',
-    require => Package['neutron-plugin-ovs']
-  })
+  if defined(File['/etc/neutron/plugin.ini']) {
+    File <| path == '/etc/neutron/plugin.ini' |> { target => '/etc/neutron/plugins/cisco/cisco_plugins.ini' }
+  }
+  else {
+    file {'/etc/neutron/plugin.ini':
+      ensure  => link,
+      target  => '/etc/neutron/plugins/cisco/cisco_plugins.ini',
+    }
+  }
 }
diff --git a/neutron/spec/classes/neutron_plugins_cisco_spec.rb b/neutron/spec/classes/neutron_plugins_cisco_spec.rb
index 8643091..df4d9de 100644
--- a/neutron/spec/classes/neutron_plugins_cisco_spec.rb
+++ b/neutron/spec/classes/neutron_plugins_cisco_spec.rb
@@ -42,8 +42,7 @@ describe 'neutron::plugins::cisco' do
     it 'should create plugin symbolic link' do
       should contain_file('/etc/neutron/plugin.ini').with(
         :ensure  => 'link',
-        :target  => '/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini',
-        :require => 'Package[neutron-plugin-ovs]'
+        :target  => '/etc/neutron/plugins/cisco/cisco_plugins.ini'
       )
     end
 
