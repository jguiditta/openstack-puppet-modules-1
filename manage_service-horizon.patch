From 4726805927de2038a82df30e6f37cc0b1ef5bda8 Mon Sep 17 00:00:00 2001
From: Lukas Bezdicka <lbezdick@redhat.com>
Date: Wed, 10 Sep 2014 19:27:11 +0200
Subject: [PATCH] Add manage_service feature for horizon

---
 manifests/init.pp                        | 10 ++++++++++
 manifests/wsgi/apache.pp                 | 10 ++++++++++
 spec/classes/horizon_init_spec.rb        |  4 ----
 spec/classes/horizon_wsgi_apache_spec.rb |  1 -
 4 files changed, 20 insertions(+), 5 deletions(-)

diff --git a/manifests/init.pp b/manifests/init.pp
index 985a564..5d93fe6 100644
--- a/manifests/init.pp
+++ b/manifests/init.pp
@@ -138,6 +138,12 @@
 #  [*configure_apache*]
 #    (optional) Configure Apache for Horizon. (Defaults to true)
 #
+#  [*manage_apache*]
+#    (optional) Start Apache. (Defaults to true)
+#
+#  [*enable_apache*]
+#    (optional) Enable Apache startup after reboot. (Defaults to true)
+#
 #  [*bind_address*]
 #    (optional) Bind address in Apache for Horizon. (Defaults to undef)
 #
@@ -209,6 +215,8 @@ class horizon(
   $help_url                = 'http://openstack.redhat.com/Docs',
   $local_settings_template = 'horizon/local_settings.py.erb',
   $configure_apache        = true,
+  $manage_apache           = true,
+  $enable_apache           = true,
   $bind_address            = undef,
   $servername              = $::fqdn,
   $server_aliases          = $::fqdn,
@@ -315,6 +323,8 @@ class horizon(
 
   if $configure_apache {
     class { 'horizon::wsgi::apache':
+      manage_service => $manage_apache,
+      enabled        => $enable_apache,
       bind_address   => $bind_address,
       servername     => $servername,
       server_aliases => $final_server_aliases,
diff --git a/manifests/wsgi/apache.pp b/manifests/wsgi/apache.pp
index 3af6ca0..c3d85ca 100644
--- a/manifests/wsgi/apache.pp
+++ b/manifests/wsgi/apache.pp
@@ -40,6 +40,8 @@
 #    (optional) A hash of extra paramaters for apache::wsgi class.
 #    Defaults to {}
 class horizon::wsgi::apache (
+  $manage_service      = true,
+  $enabled             = true,
   $bind_address        = undef,
   $fqdn                = undef,
   $servername          = $::fqdn,
@@ -67,6 +69,14 @@ class horizon::wsgi::apache (
     $final_server_aliases = $server_aliases
   }
 
+  if $manage_service {
+    if $enabled {
+      $service_ensure = 'running'
+    } else {
+      $service_ensure = 'stopped'
+    }
+  }
+
   if $::osfamily == 'RedHat' {
     class { 'apache::mod::wsgi':
       wsgi_socket_prefix => '/var/run/wsgi'
diff --git a/spec/classes/horizon_init_spec.rb b/spec/classes/horizon_init_spec.rb
index 3bd7c92..3c709df 100644
--- a/spec/classes/horizon_init_spec.rb
+++ b/spec/classes/horizon_init_spec.rb
@@ -7,10 +7,6 @@ describe 'horizon' do
       'fqdn'       => '*' }
   end
 
-  let :pre_condition do
-    'include apache'
-  end
-
   let :fixtures_path do
     File.expand_path(File.join(__FILE__, '..', '..', 'fixtures'))
   end
diff --git a/spec/classes/horizon_wsgi_apache_spec.rb b/spec/classes/horizon_wsgi_apache_spec.rb
index 68633fb..a263293 100644
--- a/spec/classes/horizon_wsgi_apache_spec.rb
+++ b/spec/classes/horizon_wsgi_apache_spec.rb
@@ -11,7 +11,6 @@ describe 'horizon::wsgi::apache' do
   end
 
   let :pre_condition do
-    "include apache\n" +
     "class { 'horizon': secret_key => 's3cr3t', configure_apache => false }"
   end
 
-- 
1.9.3

