From 0e543ac80782fa140fd4ca7fc5c8dacebac34b8b Mon Sep 17 00:00:00 2001
From: Lukas Bezdicka <lbezdick@redhat.com>
Date: Tue, 8 Sep 2015 14:10:29 +0200
Subject: [PATCH] Remove trove ubuntu package hack

Bug #1365561 has been marked as fixed so it should be safe to remove
hack adding group and file before installing package.

Change-Id: Id447a47a056a41d8c98b01d6769f4121a36d7aae
---
 trove/manifests/api.pp        |  9 +--------
 trove/manifests/conductor.pp  |  9 +--------
 trove/manifests/db/sync.pp    |  1 -
 trove/manifests/guestagent.pp |  9 +--------
 trove/manifests/init.pp       | 31 ++++---------------------------
 5 files changed, 7 insertions(+), 52 deletions(-)

diff --git a/trove/manifests/api.pp b/trove/manifests/api.pp
index 4012471..4e2ba10 100644
--- a/trove/manifests/api.pp
+++ b/trove/manifests/api.pp
@@ -177,16 +177,9 @@ class trove::api(
 
   Trove_config<||> ~> Exec['post-trove_config']
   Trove_config<||> ~> Service['trove-api']
+  Package['trove-api'] -> Trove_config<||>
   Package['trove-api'] -> Trove_api_paste_ini<||>
   Trove_api_paste_ini<||> ~> Service['trove-api']
-  # Trove db sync is broken in Ubuntu packaging
-  # This is a temporary fix until it's fixed in packaging.
-  # https://bugs.launchpad.net/ubuntu/+source/openstack-trove/+bug/1451134
-  file { '/etc/trove/trove.conf':
-    require => File['/etc/trove'],
-  }
-  File['/etc/trove/trove.conf'] -> Trove_config<||>
-  Trove_config<||> -> Package[$::trove::params::api_package_name]
 
   # basic service config
   trove_config {
diff --git a/trove/manifests/conductor.pp b/trove/manifests/conductor.pp
index 0f9b4a5..a849560 100644
--- a/trove/manifests/conductor.pp
+++ b/trove/manifests/conductor.pp
@@ -66,16 +66,9 @@ class trove::conductor(
 
   include ::trove::params
 
+  Package[$::trove::params::conductor_package_name] -> Trove_conductor_config<||>
   Trove_conductor_config<||> ~> Exec['post-trove_config']
   Trove_conductor_config<||> ~> Service['trove-conductor']
-  # Trove db sync is broken in Ubuntu packaging
-  # This is a temporary fix until it's fixed in packaging.
-  # https://bugs.launchpad.net/ubuntu/+source/openstack-trove/+bug/1451134
-  file { '/etc/trove/trove-conductor.conf':
-    require => File['/etc/trove'],
-  }
-  File['/etc/trove/trove-conductor.conf'] -> Trove_conductor_config<||>
-  Trove_conductor_config<||> -> Package[$::trove::params::conductor_package_name]
 
   if $::trove::database_connection {
     if($::trove::database_connection =~ /mysql:\/\/\S+:\S+@\S+\/\S+/) {
diff --git a/trove/manifests/db/sync.pp b/trove/manifests/db/sync.pp
index 97d69db..9d3f947 100644
--- a/trove/manifests/db/sync.pp
+++ b/trove/manifests/db/sync.pp
@@ -23,6 +23,5 @@ class trove::db::sync {
     user        => 'trove',
     refreshonly => true,
     subscribe   => Trove_config['database/connection'],
-    require     => Package['trove-api'],
   }
 }
diff --git a/trove/manifests/guestagent.pp b/trove/manifests/guestagent.pp
index 65d0740..aad16ae 100644
--- a/trove/manifests/guestagent.pp
+++ b/trove/manifests/guestagent.pp
@@ -71,16 +71,9 @@ class trove::guestagent(
 
   include ::trove::params
 
+  Package[$::trove::params::guestagent_package_name] -> Trove_guestagent_config<||>
   Trove_guestagent_config<||> ~> Exec['post-trove_config']
   Trove_guestagent_config<||> ~> Service['trove-guestagent']
-  # Trove db sync is broken in Ubuntu packaging
-  # This is a temporary fix until it's fixed in packaging.
-  # https://bugs.launchpad.net/ubuntu/+source/openstack-trove/+bug/1451134
-  file { '/etc/trove/trove-guestagent.conf':
-    require => File['/etc/trove'],
-  }
-  File['/etc/trove/trove-guestagent.conf'] -> Trove_guestagent_config<||>
-  Trove_guestagent_config<||> -> Package[$::trove::params::guestagent_package_name]
 
   # basic service config
   trove_guestagent_config {
diff --git a/trove/manifests/init.pp b/trove/manifests/init.pp
index 57bc401..5973928 100644
--- a/trove/manifests/init.pp
+++ b/trove/manifests/init.pp
@@ -308,32 +308,9 @@ class trove(
     trove_config { 'DEFAULT/neutron_url': ensure => absent }
   }
 
-  if $::osfamily == 'RedHat' {
-    # TO-DO(mmagr): Conditional should be removed as soon as following bug
-    # is really fixed. On Ubuntu trove-common is not installable without already
-    # running database and correctly filled trove.conf:
-    # https://bugs.launchpad.net/ubuntu/+source/openstack-trove/+bug/1365561
-    package { 'trove':
-      ensure => $package_ensure,
-      name   => $::trove::params::common_package_name,
-      tag    => ['openstack', 'trove-package'],
-    }
-    $group_require = Package['trove']
-  } else {
-    $group_require = undef
+  package { 'trove':
+    ensure => $package_ensure,
+    name   => $::trove::params::common_package_name,
+    tag    => ['openstack', 'trove-package'],
   }
-
-  group { 'trove':
-    ensure  => 'present',
-    name    => 'trove',
-    system  => true,
-    require => $group_require
-  }
-
-  file { '/etc/trove/':
-    ensure  => directory,
-    group   => 'trove',
-    require => Group['trove']
-  }
-
 }
